{
	# 全局配置
}

# HTTPS 服务 (端口 443)
:443 {
	# 使用内部自签名证书
	tls {
		# 使用内部 CA 发证
		issuer internal
		# 关键点：允许为握手中出现的任何主机名/IP“按需”生成证书
		on_demand
	}
	# 开启 gzip 压缩
	encode gzip

	# 静态文件根目录
	root * /usr/share/caddy

	# 1. 优先处理 /ollama 路径的反向代理
	handle_path /ollama/* {
		# 全面的 CORS 允许头
		header {
			Access-Control-Allow-Origin *
			Access-Control-Allow-Methods "GET, POST, OPTIONS"
			Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
			Access-Control-Expose-Headers "Content-Length, Content-Range, Content-Type"
			Access-Control-Max-Age 3600
		}

		# 专门处理跨域预检 (Preflight) 请求
		@options method OPTIONS
		handle @options {
			respond "" 204
		}

		# 反向代理到 Ollama
		reverse_proxy {$OLLAMA_HOST:http://host.docker.internal:11434} {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# 2. 处理其他所有请求 (静态文件 + SPA)
	handle {
		# 静态文件服务
		file_server

		# 单页应用 (SPA) 重定向：如果找不到文件，返回 index.html
		try_files {path} /index.html
	}
}
